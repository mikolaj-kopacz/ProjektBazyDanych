----------------------------------------------------------------
-- 1. TABELA: Klienci (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 1A. Procedura: Dodaj Klienta
CREATE OR REPLACE PROCEDURE sp_dodaj_klienta(
    p_imie VARCHAR, p_nazwisko VARCHAR, p_pesel CHAR, 
    p_nr_prawa_jazdy VARCHAR, p_telefon VARCHAR, p_email VARCHAR, p_adres VARCHAR
) LANGUAGE plpgsql AS $$
BEGIN
    -- Walidacja danych wejściowych
    IF p_imie IS NULL OR p_nazwisko IS NULL OR p_pesel IS NULL THEN
        RAISE EXCEPTION 'Błąd: Imię, Nazwisko i PESEL są wymagane!';
    END IF;
    
    -- Sprawdzenie duplikatu PESEL (idiotoodporność)
    IF EXISTS (SELECT 1 FROM Klienci WHERE PESEL = p_pesel) THEN
        RAISE EXCEPTION 'Błąd: Klient o podanym numerze PESEL już istnieje!';
    END IF;

    INSERT INTO Klienci (Imie, Nazwisko, PESEL, Numer_Prawa_Jazdy, Telefon, Email, Adres)
    VALUES (p_imie, p_nazwisko, p_pesel, p_nr_prawa_jazdy, p_telefon, p_email, p_adres);
END;
$$;

-- 1B. Funkcja: Pobierz Klientów
CREATE OR REPLACE FUNCTION fn_pobierz_klientow(p_id INT DEFAULT NULL)
RETURNS TABLE (ID_Klienta INT, Imie VARCHAR, Nazwisko VARCHAR, PESEL CHAR, Nr_Prawa_Jazdy VARCHAR, Telefon VARCHAR, Email VARCHAR, Adres VARCHAR) 
LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY 
    SELECT k.ID_Klienta, k.Imie, k.Nazwisko, k.PESEL, k.Numer_Prawa_Jazdy, k.Telefon, k.Email, k.Adres
    FROM Klienci k
    WHERE p_id IS NULL OR k.ID_Klienta = p_id
    ORDER BY k.ID_Klienta;
END;
$$;

-- 1C. Procedura: Aktualizuj Klienta
CREATE OR REPLACE PROCEDURE sp_aktualizuj_klienta(
    p_id INT, p_imie VARCHAR, p_nazwisko VARCHAR, p_pesel CHAR, 
    p_nr_prawa_jazdy VARCHAR, p_telefon VARCHAR, p_email VARCHAR, p_adres VARCHAR
) LANGUAGE plpgsql AS $$
BEGIN
    UPDATE Klienci
    SET Imie = COALESCE(p_imie, Imie),
        Nazwisko = COALESCE(p_nazwisko, Nazwisko),
        PESEL = COALESCE(p_pesel, PESEL),
        Numer_Prawa_Jazdy = COALESCE(p_nr_prawa_jazdy, Numer_Prawa_Jazdy),
        Telefon = COALESCE(p_telefon, Telefon),
        Email = COALESCE(p_email, Email),
        Adres = COALESCE(p_adres, Adres)
    WHERE ID_Klienta = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono klienta o ID %', p_id; END IF;
END;
$$;

-- 1D. Procedura: Usuń Klienta
CREATE OR REPLACE PROCEDURE sp_usun_klienta(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Klienci WHERE ID_Klienta = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono klienta o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 2. TABELA: Pracownicy (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 2A. Procedura: Dodaj Pracownika
CREATE OR REPLACE PROCEDURE sp_dodaj_pracownika(
    p_imie VARCHAR, p_nazwisko VARCHAR, p_stanowisko VARCHAR
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_imie IS NULL OR p_nazwisko IS NULL THEN
        RAISE EXCEPTION 'Błąd: Imię i Nazwisko pracownika są wymagane!';
    END IF;

    INSERT INTO Pracownicy (Imie, Nazwisko, Stanowisko)
    VALUES (p_imie, p_nazwisko, p_stanowisko);
END;
$$;

-- 2B. Funkcja: Pobierz Pracowników
CREATE OR REPLACE FUNCTION fn_pobierz_pracownikow(p_id INT DEFAULT NULL)
RETURNS TABLE (ID_Pracownika INT, Imie VARCHAR, Nazwisko VARCHAR, Stanowisko VARCHAR) 
LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY 
    SELECT p.ID_Pracownika, p.Imie, p.Nazwisko, p.Stanowisko
    FROM Pracownicy p
    WHERE p_id IS NULL OR p.ID_Pracownika = p_id
    ORDER BY p.ID_Pracownika;
END;
$$;

-- 2C. Procedura: Aktualizuj Pracownika
CREATE OR REPLACE PROCEDURE sp_aktualizuj_pracownika(
    p_id INT, p_imie VARCHAR, p_nazwisko VARCHAR, p_stanowisko VARCHAR
) LANGUAGE plpgsql AS $$
BEGIN
    UPDATE Pracownicy
    SET Imie = COALESCE(p_imie, Imie),
        Nazwisko = COALESCE(p_nazwisko, Nazwisko),
        Stanowisko = COALESCE(p_stanowisko, Stanowisko)
    WHERE ID_Pracownika = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono pracownika o ID %', p_id; END IF;
END;
$$;

-- 2D. Procedura: Usuń Pracownika
CREATE OR REPLACE PROCEDURE sp_usun_pracownika(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Pracownicy WHERE ID_Pracownika = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono pracownika o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 3. TABELA: Klasy_Pojazdow (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 3A. Procedura: Dodaj Klasę
CREATE OR REPLACE PROCEDURE sp_dodaj_klase(
    p_nazwa VARCHAR, p_cena DECIMAL
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_nazwa IS NULL OR p_cena IS NULL THEN
        RAISE EXCEPTION 'Błąd: Nazwa klasy i Cena są wymagane!';
    END IF;
    IF p_cena < 0 THEN 
        RAISE EXCEPTION 'Błąd: Cena nie może być ujemna!'; 
    END IF;

    INSERT INTO Klasy_Pojazdow (Nazwa_Klasy, Cena_Za_Dobe)
    VALUES (p_nazwa, p_cena);
END;
$$;

-- 3B. Funkcja: Pobierz Klasy
CREATE OR REPLACE FUNCTION fn_pobierz_klasy(p_id INT DEFAULT NULL)
RETURNS SETOF Klasy_Pojazdow LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY SELECT * FROM Klasy_Pojazdow WHERE p_id IS NULL OR ID_Klasy = p_id ORDER BY ID_Klasy;
END;
$$;

-- 3C. Procedura: Aktualizuj Klasę
CREATE OR REPLACE PROCEDURE sp_aktualizuj_klase(
    p_id INT, p_nazwa VARCHAR, p_cena DECIMAL
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_cena IS NOT NULL AND p_cena < 0 THEN 
        RAISE EXCEPTION 'Błąd: Cena nie może być ujemna!'; 
    END IF;

    UPDATE Klasy_Pojazdow
    SET Nazwa_Klasy = COALESCE(p_nazwa, Nazwa_Klasy),
        Cena_Za_Dobe = COALESCE(p_cena, Cena_Za_Dobe)
    WHERE ID_Klasy = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono klasy o ID %', p_id; END IF;
END;
$$;

-- 3D. Procedura: Usuń Klasę
CREATE OR REPLACE PROCEDURE sp_usun_klase(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Klasy_Pojazdow WHERE ID_Klasy = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono klasy o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 4. TABELA: Pojazdy (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 4A. Procedura: Dodaj Pojazd
CREATE OR REPLACE PROCEDURE sp_dodaj_pojazd(
    p_id_klasy INT, p_marka VARCHAR, p_model VARCHAR, p_rok INT, 
    p_nr_rej VARCHAR, p_przebieg INT, p_stan VARCHAR, p_status status_pojazdu
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_id_klasy IS NULL OR p_marka IS NULL OR p_model IS NULL OR p_nr_rej IS NULL THEN
        RAISE EXCEPTION 'Błąd: Klasa, Marka, Model i Rejestracja są wymagane!';
    END IF;
    
    IF EXISTS (SELECT 1 FROM Pojazdy WHERE Numer_Rejestracyjny = p_nr_rej) THEN
        RAISE EXCEPTION 'Błąd: Pojazd o numerze rejestracyjnym % już istnieje!', p_nr_rej;
    END IF;
    
    IF p_przebieg < 0 THEN RAISE EXCEPTION 'Błąd: Przebieg nie może być ujemny!'; END IF;

    INSERT INTO Pojazdy (ID_Klasy, Marka, Model, Rok_Produkcji, Numer_Rejestracyjny, Przebieg, Stan_Techniczny, Status_Dostepnosci)
    VALUES (p_id_klasy, p_marka, p_model, p_rok, p_nr_rej, p_przebieg, p_stan, p_status);
END;
$$;

-- 4B. Funkcja: Pobierz Pojazdy
CREATE OR REPLACE FUNCTION fn_pobierz_pojazdy(p_id INT DEFAULT NULL)
RETURNS SETOF Pojazdy LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY SELECT * FROM Pojazdy WHERE p_id IS NULL OR ID_Pojazdu = p_id ORDER BY ID_Pojazdu;
END;
$$;

-- 4C. Procedura: Aktualizuj Pojazd
CREATE OR REPLACE PROCEDURE sp_aktualizuj_pojazd(
    p_id INT, p_id_klasy INT, p_marka VARCHAR, p_model VARCHAR, p_rok INT, 
    p_nr_rej VARCHAR, p_przebieg INT, p_stan VARCHAR, p_status status_pojazdu
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_przebieg IS NOT NULL AND p_przebieg < 0 THEN RAISE EXCEPTION 'Błąd: Przebieg nie może być ujemny!'; END IF;

    UPDATE Pojazdy
    SET ID_Klasy = COALESCE(p_id_klasy, ID_Klasy),
        Marka = COALESCE(p_marka, Marka),
        Model = COALESCE(p_model, Model),
        Rok_Produkcji = COALESCE(p_rok, Rok_Produkcji),
        Numer_Rejestracyjny = COALESCE(p_nr_rej, Numer_Rejestracyjny),
        Przebieg = COALESCE(p_przebieg, Przebieg),
        Stan_Techniczny = COALESCE(p_stan, Stan_Techniczny),
        Status_Dostepnosci = COALESCE(p_status, Status_Dostepnosci)
    WHERE ID_Pojazdu = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono pojazdu o ID %', p_id; END IF;
END;
$$;

-- 4D. Procedura: Usuń Pojazd
CREATE OR REPLACE PROCEDURE sp_usun_pojazd(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Pojazdy WHERE ID_Pojazdu = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono pojazdu o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 5. TABELA: Rezerwacje (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 5A. Procedura: Dodaj Rezerwację
CREATE OR REPLACE PROCEDURE sp_dodaj_rezerwacje(
    p_id_klienta INT, p_id_pojazdu INT, p_id_pracownika INT, 
    p_data_rez DATE, p_data_odb DATE, p_data_zwr DATE, 
    p_miejsce VARCHAR, p_cena DECIMAL, p_status status_rezerwacji
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_id_klienta IS NULL OR p_id_pojazdu IS NULL OR p_data_odb IS NULL OR p_data_zwr IS NULL THEN
        RAISE EXCEPTION 'Błąd: Klient, Pojazd i Daty (odbioru/zwrotu) są wymagane!';
    END IF;
    
    IF p_data_zwr < p_data_odb THEN
        RAISE EXCEPTION 'Błąd: Data zwrotu nie może być wcześniejsza niż data odbioru!';
    END IF;

    INSERT INTO Rezerwacje (ID_Klienta, ID_Pojazdu, ID_Pracownika, Data_Rezerwacji, Data_Odbioru, Data_Zwrotu, Miejsce_Odbioru, Cena_Calkowita, Status_Rezerwacji)
    VALUES (p_id_klienta, p_id_pojazdu, p_id_pracownika, p_data_rez, p_data_odb, p_data_zwr, p_miejsce, p_cena, p_status);
END;
$$;

-- 5B. Funkcja: Pobierz Rezerwacje
CREATE OR REPLACE FUNCTION fn_pobierz_rezerwacje(p_id INT DEFAULT NULL)
RETURNS SETOF Rezerwacje LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY SELECT * FROM Rezerwacje WHERE p_id IS NULL OR ID_Rezerwacji = p_id ORDER BY ID_Rezerwacji DESC;
END;
$$;

-- 5C. Procedura: Aktualizuj Rezerwację
CREATE OR REPLACE PROCEDURE sp_aktualizuj_rezerwacje(
    p_id INT, p_id_klienta INT, p_id_pojazdu INT, p_id_pracownika INT,
    p_data_rez DATE, p_data_odb DATE, p_data_zwr DATE, 
    p_miejsce VARCHAR, p_cena DECIMAL, p_status status_rezerwacji
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_data_odb IS NOT NULL AND p_data_zwr IS NOT NULL AND p_data_zwr < p_data_odb THEN
         RAISE EXCEPTION 'Błąd: Data zwrotu nie może być wcześniejsza niż data odbioru!';
    END IF;

    UPDATE Rezerwacje
    SET ID_Klienta = COALESCE(p_id_klienta, ID_Klienta),
        ID_Pojazdu = COALESCE(p_id_pojazdu, ID_Pojazdu),
        ID_Pracownika = COALESCE(p_id_pracownika, ID_Pracownika),
        Data_Rezerwacji = COALESCE(p_data_rez, Data_Rezerwacji),
        Data_Odbioru = COALESCE(p_data_odb, Data_Odbioru),
        Data_Zwrotu = COALESCE(p_data_zwr, Data_Zwrotu),
        Miejsce_Odbioru = COALESCE(p_miejsce, Miejsce_Odbioru),
        Cena_Calkowita = COALESCE(p_cena, Cena_Calkowita),
        Status_Rezerwacji = COALESCE(p_status, Status_Rezerwacji)
    WHERE ID_Rezerwacji = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono rezerwacji o ID %', p_id; END IF;
END;
$$;

-- 5D. Procedura: Usuń Rezerwację
CREATE OR REPLACE PROCEDURE sp_usun_rezerwacje(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Rezerwacje WHERE ID_Rezerwacji = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono rezerwacji o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 6. TABELA: Uslugi_Dodatkowe (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 6A. Procedura: Dodaj Usługę
CREATE OR REPLACE PROCEDURE sp_dodaj_usluge(
    p_nazwa VARCHAR, p_cena DECIMAL
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_nazwa IS NULL OR p_cena IS NULL THEN
        RAISE EXCEPTION 'Błąd: Nazwa usługi i Cena są wymagane!';
    END IF;
    IF p_cena < 0 THEN RAISE EXCEPTION 'Błąd: Cena usługi nie może być ujemna!'; END IF;

    INSERT INTO Uslugi_Dodatkowe (Nazwa_Uslugi, Cena) VALUES (p_nazwa, p_cena);
END;
$$;

-- 6B. Funkcja: Pobierz Usługi
CREATE OR REPLACE FUNCTION fn_pobierz_uslugi(p_id INT DEFAULT NULL)
RETURNS SETOF Uslugi_Dodatkowe LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY SELECT * FROM Uslugi_Dodatkowe WHERE p_id IS NULL OR ID_Uslugi = p_id ORDER BY ID_Uslugi;
END;
$$;

-- 6C. Procedura: Aktualizuj Usługę
CREATE OR REPLACE PROCEDURE sp_aktualizuj_usluge(
    p_id INT, p_nazwa VARCHAR, p_cena DECIMAL
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_cena IS NOT NULL AND p_cena < 0 THEN RAISE EXCEPTION 'Błąd: Cena usługi nie może być ujemna!'; END IF;

    UPDATE Uslugi_Dodatkowe
    SET Nazwa_Uslugi = COALESCE(p_nazwa, Nazwa_Uslugi),
        Cena = COALESCE(p_cena, Cena)
    WHERE ID_Uslugi = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono usługi o ID %', p_id; END IF;
END;
$$;

-- 6D. Procedura: Usuń Usługę
CREATE OR REPLACE PROCEDURE sp_usun_usluge(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Uslugi_Dodatkowe WHERE ID_Uslugi = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono usługi o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 7. TABELA: Rezerwacje_Uslugi (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 7A. Procedura: Dodaj Usługę do Rezerwacji
CREATE OR REPLACE PROCEDURE sp_dodaj_usluge_do_rezerwacji(
    p_id_rez INT, p_id_uslugi INT
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_id_rez IS NULL OR p_id_uslugi IS NULL THEN
        RAISE EXCEPTION 'Błąd: ID Rezerwacji i ID Usługi są wymagane!';
    END IF;

    -- Sprawdzenie duplikatu (czy ta usługa już jest w tej rezerwacji)
    IF EXISTS (SELECT 1 FROM Rezerwacje_Uslugi WHERE ID_Rezerwacji = p_id_rez AND ID_Uslugi = p_id_uslugi) THEN
        RAISE EXCEPTION 'Błąd: Ta usługa jest już przypisana do tej rezerwacji!';
    END IF;

    INSERT INTO Rezerwacje_Uslugi (ID_Rezerwacji, ID_Uslugi) VALUES (p_id_rez, p_id_uslugi);
END;
$$;

-- 7B. Funkcja: Pobierz Usługi Rezerwacji
CREATE OR REPLACE FUNCTION fn_pobierz_uslugi_rezerwacji(p_id_rez INT)
RETURNS TABLE (ID_Przypisania INT, RezerwacjaID INT, Nazwa_Uslugi VARCHAR, Cena DECIMAL) 
LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY 
    SELECT ru.ID_Rezerwacji_Uslugi, ru.ID_Rezerwacji, u.Nazwa_Uslugi, u.Cena
    FROM Rezerwacje_Uslugi ru
    JOIN Uslugi_Dodatkowe u ON ru.ID_Uslugi = u.ID_Uslugi
    WHERE ru.ID_Rezerwacji = p_id_rez;
END;
$$;

-- 7C. Procedura: Aktualizuj Przypisanie Usługi
CREATE OR REPLACE PROCEDURE sp_aktualizuj_usluge_rezerwacji(
    p_id_rez_uslugi INT, p_nowe_id_uslugi INT
) LANGUAGE plpgsql AS $$
BEGIN
    UPDATE Rezerwacje_Uslugi
    SET ID_Uslugi = p_nowe_id_uslugi
    WHERE ID_Rezerwacji_Uslugi = p_id_rez_uslugi;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono przypisania usługi o ID %', p_id_rez_uslugi; END IF;
END;
$$;

-- 7D. Procedura: Usuń Usługę z Rezerwacji
CREATE OR REPLACE PROCEDURE sp_usun_usluge_z_rezerwacji(p_id_rez_uslugi INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Rezerwacje_Uslugi WHERE ID_Rezerwacji_Uslugi = p_id_rez_uslugi;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono przypisania usługi o ID %', p_id_rez_uslugi; END IF;
END;
$$;


----------------------------------------------------------------
-- 8. TABELA: Platnosci (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 8A. Procedura: Dodaj Płatność
CREATE OR REPLACE PROCEDURE sp_dodaj_platnosc(
    p_id_rez INT, p_kwota DECIMAL, p_data DATE, 
    p_forma forma_platnosci, p_status status_platnosci, p_faktura VARCHAR
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_id_rez IS NULL OR p_kwota IS NULL THEN
        RAISE EXCEPTION 'Błąd: ID Rezerwacji i Kwota są wymagane!';
    END IF;

    INSERT INTO Platnosci (ID_Rezerwacji, Kwota_Calkowita, Data_Platnosci, Forma_Platnosci, Status_Platnosci, Numer_Faktury)
    VALUES (p_id_rez, p_kwota, p_data, p_forma, p_status, p_faktura);
END;
$$;

-- 8B. Funkcja: Pobierz Płatności
CREATE OR REPLACE FUNCTION fn_pobierz_platnosci(p_id INT DEFAULT NULL)
RETURNS SETOF Platnosci LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY SELECT * FROM Platnosci WHERE p_id IS NULL OR ID_Platnosci = p_id ORDER BY ID_Platnosci;
END;
$$;

-- 8C. Procedura: Aktualizuj Płatność
CREATE OR REPLACE PROCEDURE sp_aktualizuj_platnosc(
    p_id INT, p_kwota DECIMAL, p_data DATE, 
    p_forma forma_platnosci, p_status status_platnosci, p_faktura VARCHAR
) LANGUAGE plpgsql AS $$
BEGIN
    UPDATE Platnosci
    SET Kwota_Calkowita = COALESCE(p_kwota, Kwota_Calkowita),
        Data_Platnosci = COALESCE(p_data, Data_Platnosci),
        Forma_Platnosci = COALESCE(p_forma, Forma_Platnosci),
        Status_Platnosci = COALESCE(p_status, Status_Platnosci),
        Numer_Faktury = COALESCE(p_faktura, Numer_Faktury)
    WHERE ID_Platnosci = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono płatności o ID %', p_id; END IF;
END;
$$;

-- 8D. Procedura: Usuń Płatność
CREATE OR REPLACE PROCEDURE sp_usun_platnosc(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Platnosci WHERE ID_Platnosci = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono płatności o ID %', p_id; END IF;
END;
$$;


----------------------------------------------------------------
-- 9. TABELA: Serwisy (3 Procedury + 1 Funkcja)
----------------------------------------------------------------

-- 9A. Procedura: Dodaj Serwis
CREATE OR REPLACE PROCEDURE sp_dodaj_serwis(
    p_id_pojazdu INT, p_data DATE, p_opis VARCHAR, p_koszt DECIMAL, p_przebieg INT
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_id_pojazdu IS NULL OR p_data IS NULL THEN
        RAISE EXCEPTION 'Błąd: ID Pojazdu i Data serwisu są wymagane!';
    END IF;
    
    IF p_koszt < 0 THEN RAISE EXCEPTION 'Błąd: Koszt serwisu nie może być ujemny!'; END IF;
    IF p_przebieg < 0 THEN RAISE EXCEPTION 'Błąd: Przebieg nie może być ujemny!'; END IF;

    INSERT INTO Serwisy (ID_Pojazdu, Data_Serwisu, Opis, Koszt, Przebieg_W_Chwili_Serwisu)
    VALUES (p_id_pojazdu, p_data, p_opis, p_koszt, p_przebieg);
END;
$$;

-- 9B. Funkcja: Pobierz Serwisy
CREATE OR REPLACE FUNCTION fn_pobierz_serwisy(p_id INT DEFAULT NULL)
RETURNS SETOF Serwisy LANGUAGE plpgsql AS $$
BEGIN
    RETURN QUERY 
    SELECT * FROM Serwisy 
    WHERE p_id IS NULL OR ID_Serwisu = p_id 
    ORDER BY Data_Serwisu DESC;
END;
$$;

-- 9C. Procedura: Aktualizuj Serwis
CREATE OR REPLACE PROCEDURE sp_aktualizuj_serwis(
    p_id INT, p_id_pojazdu INT, p_data DATE, p_opis VARCHAR, p_koszt DECIMAL, p_przebieg INT
) LANGUAGE plpgsql AS $$
BEGIN
    IF p_koszt IS NOT NULL AND p_koszt < 0 THEN RAISE EXCEPTION 'Błąd: Koszt nie może być ujemny!'; END IF;
    IF p_przebieg IS NOT NULL AND p_przebieg < 0 THEN RAISE EXCEPTION 'Błąd: Przebieg nie może być ujemny!'; END IF;

    UPDATE Serwisy
    SET ID_Pojazdu = COALESCE(p_id_pojazdu, ID_Pojazdu),
        Data_Serwisu = COALESCE(p_data, Data_Serwisu),
        Opis = COALESCE(p_opis, Opis),
        Koszt = COALESCE(p_koszt, Koszt),
        Przebieg_W_Chwili_Serwisu = COALESCE(p_przebieg, Przebieg_W_Chwili_Serwisu)
    WHERE ID_Serwisu = p_id;
    
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono wpisu serwisowego o ID %', p_id; END IF;
END;
$$;

-- 9D. Procedura: Usuń Serwis
CREATE OR REPLACE PROCEDURE sp_usun_serwis(p_id INT) 
LANGUAGE plpgsql AS $$
BEGIN
    DELETE FROM Serwisy WHERE ID_Serwisu = p_id;
    IF NOT FOUND THEN RAISE EXCEPTION 'Nie znaleziono wpisu serwisowego o ID %', p_id; END IF;
END;
$$;

1. TOP 5 klientów, którzy wydali najwięcej pieniędzy
Algorytm

Pobierz wszystkie płatności.

Połącz je z rezerwacjami i klientami.

Zsumuj kwoty dla każdego klienta.

Posortuj malejąco.

Zwróć 5 największych wartości.

SQL
SELECT k.id_klienta, k.imie, k.nazwisko, SUM(p.kwota_calkowita) AS suma
FROM platnosci p
JOIN rezerwacje r ON p.id_rezerwacji = r.id_rezerwacji
JOIN klienci k ON r.id_klienta = k.id_klienta
GROUP BY k.id_klienta
ORDER BY suma DESC
LIMIT 5;

2. Pojazdy serwisowane ponad 3 razy
Algorytm

Pobierz wpisy z serwisów.

Pogrupuj po pojeździe.

Policz serwisy.

Zwróć pojazdy z liczbą > 3.

SQL
SELECT p.id_pojazdu, p.marka, p.model, COUNT(s.id_serwisu) AS liczba_serwisow
FROM pojazdy p
JOIN serwisy s ON p.id_pojazdu = s.id_pojazdu
GROUP BY p.id_pojazdu
HAVING COUNT(s.id_serwisu) > 3;

3. Obciążenie pracowników
Algorytm

Pobierz pracowników.

Połącz z rezerwacjami.

Policz rezerwacje dla każdego pracownika.

SQL
SELECT pr.id_pracownika, pr.imie, pr.nazwisko, COUNT(r.id_rezerwacji) AS liczba_rezerwacji
FROM pracownicy pr
LEFT JOIN rezerwacje r ON pr.id_pracownika = r.id_pracownika
GROUP BY pr.id_pracownika;

4. Samochody aktualnie wypożyczone
Algorytm

Pobierz pojazdy.

Wybierz te ze statusem "wypożyczony".

SQL
SELECT marka, model, numer_rejestracyjny
FROM pojazdy
WHERE status_dostepnosci = 'Wypożyczony';

5. Rezerwacje powyżej średniej ceny
Algorytm

Oblicz średnią cenę.

Zwróć rezerwacje droższe niż średnia.

SQL
SELECT *
FROM rezerwacje
WHERE cena_calkowita > (SELECT AVG(cena_calkowita) FROM rezerwacje);

6. Popularność usług dodatkowych
Algorytm

Pobierz listę usług.

Zlicz wystąpienia w tabeli rezerwacje_uslugi.

SQL
SELECT u.nazwa_uslugi, COUNT(ru.id_uslugi) AS ile_razy
FROM uslugi_dodatkowe u
LEFT JOIN rezerwacje_uslugi ru ON u.id_uslugi = ru.id_uslugi
GROUP BY u.id_uslugi
ORDER BY ile_razy DESC;

7. Klienci bez rezerwacji
Algorytm

Pobierz klientów.

Zrób lewy join z rezerwacjami.

Zwróć tych bez rezerwacji.

SQL
SELECT k.*
FROM klienci k
LEFT JOIN rezerwacje r ON k.id_klienta = r.id_klienta
WHERE r.id_rezerwacji IS NULL;

8. Najdroższa rezerwacja każdego klienta
Algorytm

Pobierz wszystkie rezerwacje.

Nadaj numer w grupie (funkcja okienkowa).

Wybierz pierwszą w każdej grupie.

SQL
SELECT *
FROM (
    SELECT k.id_klienta, k.imie, k.nazwisko,
           r.id_rezerwacji, r.cena_calkowita,
           ROW_NUMBER() OVER (PARTITION BY k.id_klienta ORDER BY r.cena_calkowita DESC) AS rn
    FROM rezerwacje r
    JOIN klienci k ON r.id_klienta = k.id_klienta
) t
WHERE rn = 1;

9. TOP 3 pojazdy z największą liczbą rezerwacji
Algorytm

Pogrupuj rezerwacje po pojeździe.

Policz rezerwacje.

Zwróć 3 największe.

SQL
SELECT p.id_pojazdu, p.marka, p.model, COUNT(r.id_rezerwacji) AS ile_razy
FROM pojazdy p
JOIN rezerwacje r ON p.id_pojazdu = r.id_pojazdu
GROUP BY p.id_pojazdu
ORDER BY ile_razy DESC
LIMIT 3;

10. Klienci korzystający z usług dodatkowych
Algorytm

Pobierz powiązania rezerwacji z usługami.

Dołącz do klientów.

Zwróć unikalnych klientów.

SQL
SELECT DISTINCT k.id_klienta, k.imie, k.nazwisko
FROM klienci k
JOIN rezerwacje r ON k.id_klienta = r.id_klienta
JOIN rezerwacje_uslugi ru ON r.id_rezerwacji = ru.id_rezerwacji;

11. Średni koszt serwisu dla każdej marki
Algorytm

Połącz serwisy z pojazdami.

Pogrupuj po marce.

Oblicz średnią.

SQL
SELECT p.marka, AVG(s.koszt) AS sredni_koszt
FROM serwisy s
JOIN pojazdy p ON s.id_pojazdu = p.id_pojazdu
GROUP BY p.marka;

12. Najdłuższe rezerwacje
Algorytm

Oblicz różnicę dat.

Połącz z klientami.

Posortuj malejąco.

SQL
SELECT r.id_rezerwacji, k.imie, k.nazwisko,
       (r.data_zwrotu - r.data_odbioru) AS dni
FROM rezerwacje r
JOIN klienci k ON k.id_klienta = r.id_klienta
ORDER BY dni DESC;

13. Miesięczne przychody
Algorytm

Zgrupuj płatności po miesiącu.

Policz sumę.

SQL
SELECT DATE_TRUNC('month', data_platnosci) AS miesiac,
       SUM(kwota_calkowita) AS przychod
FROM platnosci
GROUP BY DATE_TRUNC('month', data_platnosci)
ORDER BY miesiac;

14. Usługi w najdroższej rezerwacji
Algorytm

Znajdź najdroższą rezerwację.

Pobierz jej ID.

Wyświetl usługi powiązane z tym ID.

SQL
SELECT u.nazwa_uslugi, u.cena
FROM uslugi_dodatkowe u
JOIN rezerwacje_uslugi ru ON u.id_uslugi = ru.id_uslugi
WHERE ru.id_rezerwacji = (
    SELECT id_rezerwacji
    FROM rezerwacje
    ORDER BY cena_calkowita DESC
    LIMIT 1
);

15. Samochody wymagające serwisu (> 15 000 km)
Algorytm

Pobierz ostatni serwis pojazdu.

Pobierz aktualny przebieg pojazdów.

Oblicz różnicę.

Zwróć te > 15000.

SQL
WITH ostatni_serwis AS (
    SELECT id_pojazdu,
           MAX(przebieg_w_chwili_serwisu) AS przebieg_po_serwisie
    FROM serwisy
    GROUP BY id_pojazdu
)
SELECT p.id_pojazdu, p.marka, p.model, p.przebieg
FROM pojazdy p
JOIN ostatni_serwis s ON p.id_pojazdu = s.id_pojazdu
WHERE p.przebieg - s.przebieg_po_serwisie > 15000;
